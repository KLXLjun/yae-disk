<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>YaeDisk</title>
    <link rel="stylesheet" href="/static/mdui/css/mdui.min.css" />
    <link rel="stylesheet" href="/static/css/1.css" />
    <script src="/static/mdui/js/mdui.min.js" type="text/javascript"/></script>
    <script src="/static/js/axios.min.js"></script>
    <style>
        body{
            position: fixed;
            height: 100%;
            width: 100%;
        }
    </style>
</head>
<body class="mdui-appbar-with-toolbar mdui-theme-primary-indigo mdui-theme-accent-pink">
    <div id="app">
        <header class="mdui-appbar mdui-appbar-fixed">
            <div class="mdui-toolbar mdui-color-theme">
                <!-- <span class="mdui-btn mdui-btn-icon mdui-ripple mdui-ripple-white" mdui-drawer="{target: '#main-drawer', swipe: true}"><i class="mdui-icon material-icons">menu</i></span> -->
                <a class="mdui-typo-headline mdui-hidden-xs">Disk</a>
                <div class="mdui-toolbar-spacer"></div>
            </div>
        </header>
        <div class="mdui-container doc-container">
            <h2>正在浏览目录 - <span id="pathDirName">载入...</span></h2>
            <div class="mdui-btn-group" style="margin-bottom: 25px;">
                <button type="button" class="mdui-btn unline" mdui-tooltip="{content: '后退'}"><i class="mdui-icon material-icons">&#xe5c4;</i></button>
                <button type="button" class="mdui-btn unline" mdui-tooltip="{content: '前进'}"><i class="mdui-icon material-icons">&#xe5c8;</i></button>
                <button type="button" class="mdui-btn unline" mdui-tooltip="{content: '回到根目录'}"><i class="mdui-icon material-icons">&#xe5d8;</i></button>
                <span class="gbtn-c">&nbsp;</span>
                <button type="button" class="mdui-btn unline" mdui-tooltip="{content: '上传文件'}" mdui-dialog="{target: '#upload-file'}"><i class="mdui-icon material-icons">&#xe2c6;</i></button>
                <button type="button" class="mdui-btn unline" mdui-tooltip="{content: '创建文件夹'}"><i class="mdui-icon material-icons">&#xe2cc;</i></button>
                <button type="button" class="mdui-btn unline" mdui-tooltip="{content: '文件夹信息'}"><i class="mdui-icon material-icons">&#xe88f;</i></button>
                <span class="gbtn-c">&nbsp;</span>
                <button type="button" class="mdui-btn unline" mdui-tooltip="{content: '复制'}"><i class="mdui-icon material-icons">&#xe14d;</i></button>
                <button type="button" class="mdui-btn unline" mdui-tooltip="{content: '剪切'}"><i class="mdui-icon material-icons">&#xe14e;</i></button>
                <button type="button" class="mdui-btn unline" mdui-tooltip="{content: '粘贴'}"><i class="mdui-icon material-icons">&#xe14f;</i></button>
            </div>
            <div class="mdui-table-fluid">
                <table id="filetable" class="mdui-table mdui-table-hoverable mdui-table-selectable">
                    <thead>
                    <tr>
                        <th>名称</th>
                        <th>最近修改时间</th>
                        <th>大小</th>
                    </tr>
                    </thead>
                    <tbody id="folder_list" v-for="fls in NowFolderF.Folderlist">
                    <tr @contextmenu.prevent="openMenu($event,0,fls.folder_id)" data-type="0" :data-folderid='fls.folder_id' class="cpointer">
                        <td>{{ fls.FolderName }}</td>
                        <td>-</td>
                        <td>-</td>
                    </tr>
                    </tbody>
                    <tbody id="file_list" v-for="fls in NowFolderF.Filelist">
                    <tr @contextmenu.prevent="openMenu($event,1,fls.file_id)" data-type="1" :data-folderid='fls.fls.file_id' class="cpointer">
                        <td>{{ fls.FileName }}{{ fls.ExtName }}</td>
                        <td>{{ fls.ChangeTime }}</td>
                        <td>{{ fls.Size }}</td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <div style="margin-top: 8px;">文件:<span id="fileCount"></span> 文件夹:<span id="folderCount"></span></div>
        </div>
        <div class="dm-lightbox-wrapper" id="fullscreen_view" style="display: none;">
            <div class="dm-lightbox">
                <div class="dm-lightbox-image">
                    <img id="full_view_img" src="" alt="">
                </div>
            </div>
            <div class="dm-lightbox-ctrl">
                <div class="dm-lightbox-close">
                    <span style="size: 20px;cursor: pointer;" onclick="File_PreView_close()">关闭</span>
                </div>
                <div class="dm-lightbox-info" id="fullfile_info">
                    <p class="infos">文件基本信息</p>
                    <p class="infos">获取中</p>
                </div>
            </div>
        </div>
        <!-- <div style="position: absolute;z-index: 1500;top: 0;left: 0;height: 100%;width: 100%;background-color: rgba(0, 0, 0, 0.507);display: block;">
            <img src="/preview/save/Texture2D/cg_000c.png">
            <div style="height: 95%;width: 95%;background-image: url('/preview/save/Texture2D/cg_000c.png');background-repeat: no-repeat;background-position:center;background-size: cover;">

            </div>
        </div> -->
        <ul id="rightMenu" class="mdui-list contextmenu mdui-shadow-1 mdui-text-color-theme-text" oncontextmenu="return false;" style="background-color: white;display:none;left: 0px;top: 0px">
            <li class="mdui-list-item mdui-ripple" id="rghm1">
                <a onclick="console.log(returnFileInfo(rightClickItem))"></a>
                <i class="mdui-icon material-icons">&#xe895;</i>
                <div class="mdui-list-item-content" style="margin-left: 24px;">预览</div>
            </li>
            <li class="mdui-list-item mdui-ripple" id="rghm2">
                <i class="mdui-icon material-icons">&#xe2c4;</i>
                <div class="mdui-list-item-content" style="margin-left: 24px;">下载</div>
            </li>
            <li class="mdui-list-item mdui-ripple">
                <i class="mdui-icon material-icons">&#xe14d;</i>
                <div class="mdui-list-item-content" style="margin-left: 24px;">复制</div>
            </li>
            <li class="mdui-list-item mdui-ripple">
                <i class="mdui-icon material-icons">&#xe14e;</i>
                <div class="mdui-list-item-content" style="margin-left: 24px;">剪切</div>
            </li>
            <li class="mdui-list-item mdui-ripple">
                <i class="mdui-icon material-icons">&#xe14f;</i>
                <div class="mdui-list-item-content" style="margin-left: 24px;">粘贴</div>
            </li>
            <li class="mdui-list-item mdui-ripple">
                <i class="mdui-icon material-icons">&#xe254;</i>
                <div class="mdui-list-item-content" style="margin-left: 24px;">重命名</div>
            </li>
            <li class="mdui-list-item mdui-ripple">
                <i class="mdui-icon material-icons">&#xe872;</i>
                <div class="mdui-list-item-content" style="margin-left: 24px;">删除</div>
            </li>
            <li class="mdui-list-item mdui-ripple">
                <i class="mdui-icon material-icons">&#xe157;</i>
                <div class="mdui-list-item-content" style="margin-left: 24px;">分享</div>
            </li>
            <li class="mdui-list-item mdui-ripple">
                <i class="mdui-icon material-icons">&#xe5d3;</i>
                <div class="mdui-list-item-content" style="margin-left: 24px;">信息</div>
            </li>
        </ul>
    </div>
    <div class="mdui-dialog" id="upload-file">
        <div class="mdui-dialog-title">上传文件</div>
        <div class="mdui-dialog-content">
            <div>
                <progress id="progressBar" value="0" max="100" style="width: 100%"></progress>
            </div>
            <span id="percentage">准备就绪</span>&nbsp;<span id="time"></span>
            <br /><br />
            <span id="upfilename">未选择文件</span>
            <br />
            <input style="display: none;" type="file" id="file" name="myfile" />
            <button class="mdui-btn mdui-color-theme-accent mdui-ripple" onclick="document.getElementById('file').click()"><i class="mdui-icon material-icons">&#xe24d;</i>&nbsp;选择文件</button>
            <button class="mdui-btn mdui-color-theme-accent mdui-ripple" onclick="UpladFile()"><i class="mdui-icon material-icons">&#xe2c3;</i>&nbsp;开始上传</button>
            <button class="mdui-btn mdui-color-theme-accent mdui-ripple" onclick="cancleUploadFile()"><i class="mdui-icon material-icons">&#xe5cd;</i>&nbsp;取消上传</button>
        </div>
        <div class="mdui-dialog-actions">
            <button class="mdui-btn mdui-ripple" mdui-dialog-close>关闭</button>
        </div>
    </div>
</body>
<script>
    var rightClickItem = -1,
        rightClickItemType = -1;
    var rightMenuVisible = false;
    var fileList = [],
        folderList = [];
    var currentFolderID = -1,
        currentFolderName = "载入中",
        change_time = "2022-03-12 20:47:58",
        create_time = "2022-03-12 20:47:58",
        owner_folder_id = "0",
        owner_user_id = "0";

    var ot,oloaded;
    //图片上传
    var xhr;
    //上传文件方法
    document.getElementById("file").addEventListener("change",function (e) {
        var fileObj = document.getElementById("file").files[0]; // js 获取文件对象
        console.log(fileObj.name)
        upfilename.innerText = fileObj.name
    });
    function UpladFile() {
        var fileObj = document.getElementById("file").files[0]; // js 获取文件对象
        console.log(fileObj.name)
        upfilename.innerText = fileObj.name;

        let origin = ""
        if (!window.location.origin) {
            origin = window.location.protocol + "//" + window.location.hostname + (window.location.port ? ':' + window.location.port: '');
        }else{
            origin = window.location.origin
        }
        var url =  origin + "/api/file/upload/" + currentFolderID; // 接收上传文件的后台地址

        var form = new FormData(); // FormData 对象
        form.append("upload", fileObj); // 文件对象

        xhr = new XMLHttpRequest();  // XMLHttpRequest 对象
        xhr.open("post", url, true); //post方式，url为服务器请求地址，true 该参数规定请求是否异步处理。
        xhr.onload = uploadComplete; //请求完成
        xhr.onerror =  uploadFailed; //请求失败

        xhr.upload.onprogress = progressFunction;//【上传进度调用方法实现】
        xhr.upload.onloadstart = function(){//上传开始执行方法
            ot = new Date().getTime();   //设置上传开始时间
            oloaded = 0;//设置上传开始时，以上传的文件大小为0
        };

        ot = new Date().getTime(); //重新赋值时间，用于下次计算
        xhr.send(form); //开始上传，发送form数据
    }

    //上传成功响应
    function uploadComplete(evt) {
        //服务断接收完文件返回的结果
        console.log(evt)
        var time = document.getElementById("time");
        time.innerText = "上传操作已完成"
        /*
        var data = JSON.parse(evt.target.responseText);
        if(data.success) {
            alert("上传成功！");
        }else{
            alert("上传失败！");
        }
        */
    }
    //上传失败
    function uploadFailed(evt) {
        alert("上传失败！");
    }
    //取消上传
    function cancleUploadFile(){
        xhr.abort();
    }

    //上传进度实现方法，上传过程中会频繁调用该方法
    function progressFunction(evt) {
        var progressBar = document.getElementById("progressBar");
        var percentageDiv = document.getElementById("percentage");
        // event.total是需要传输的总字节，event.loaded是已经传输的字节。如果event.lengthComputable不为真，则event.total等于0
        if (evt.lengthComputable) {//
            progressBar.max = evt.total;
            progressBar.value = evt.loaded;
            percentageDiv.innerHTML = Math.round(evt.loaded / evt.total * 100) + "%";
        }
        var time = document.getElementById("time");
        var nt = new Date().getTime();//获取当前时间
        var pertime = (nt-ot)/1000; //计算出上次调用该方法时到现在的时间差，单位为s
        if(pertime>1){
            ot = new Date().getTime(); //重新赋值时间，用于下次计算
        }

        var perload = evt.loaded - oloaded; //计算该分段上传的文件大小，单位b
        if(pertime>1){
            oloaded = evt.loaded;//重新赋值已上传文件大小，用以下次计算
        }

        //上传速度计算
        var speed = perload/pertime;//单位b/s
        var bspeed = speed;
        var units = 'b/s';//单位名称
        if(speed/1024>1){
            speed = speed/1024;
            units = 'k/s';
        }
        if(speed/1024>1){
            speed = speed/1024;
            units = 'M/s';
        }
        speed = speed.toFixed(1);
        //剩余时间
        var resttime = ((evt.total-evt.loaded)/bspeed).toFixed(1);
        time.innerHTML = '，速度：'+speed+units+'，剩余时间：'+resttime+'s';
        if(bspeed==0) time.innerHTML = '上传已取消';
    }
</script>
<script>
    function ChangeMenu(type) {
        if(type == 0){
            console.log("选中文件夹")
            document.getElementById("rghm1").style.display = "none";
            document.getElementById("rghm2").style.display = "flex";
        }else if(type == 1){
            console.log("选中文件")
            document.getElementById("rghm1").style.display = "flex";
            document.getElementById("rghm2").style.display = "none";
        }
    }

    document.body.addEventListener('click', function (e) {
        rightMenuVisible = false;
        document.getElementById("rightMenu").style.display = "none";
    });

    function openMenu(e, type, item) {
        rightClickItem = item;
        rightClickItemType = type;

        e.preventDefault();
        let x = e.clientX;
        let y = e.clientY;

        document.getElementById("rightMenu").style.top = y + "px";
        document.getElementById("rightMenu").style.left = x + "px";

        let h;
        e.path.forEach(element => {
            //console.log(element)
            if(element.classList != null && element.classList.contains('cpointer') && h == null){
                h = element;
            }
        });

        if(h){
            console.log(rightClickItem,rightClickItemType);
            ChangeMenu(rightClickItemType)

            rightMenuVisible = true;
            document.getElementById("rightMenu").style.display = "block";
        }
    }

    function returnFileInfo(id){
        if(id < 0) return null;
        let listcache = this.NowFolderF.Filelist
        for (let index = 0; index < listcache.length; index++) {
            const element = listcache[index];
            if(element.FileID == id){
                return element
            }
        }
    }
    //rightmenu func
    function PreviewFile(sfile){
        if(sfile){

        }else{
            mdui.alert('文件不正确', '预览错误');
        }
    }

    function GetFolderAndFile(path){
        axios.get('/api/disk' + path).then(function(res){
            console.log(res.data);
            let p = res.data;
            let pflist = p.file;
            currentFolderID = p.folder_id;
            console.log(p.folder_id)
            currentFolderName = p.folder_name;
            document.getElementById("pathDirName").innerText = p.folder_name;

            for (let index = 0; index < pflist.length; index++) {
                let element = pflist[index];
                element.file_size = GetM(element.file_size)
                pflist[index] = element;
            }

            fileList = p.file;
            folderList = p.folder;

            document.getElementById("fileCount").innerText = fileList.length;
            document.getElementById("folderCount").innerText = folderList.length;

            document.getElementById("folder_list").innerHTML = "";
            for (let folderElement of p.folder) {
                let element = GenTableRow(folderElement,0)
                document.getElementById("folder_list").appendChild(element);
            }

            document.getElementById("file_list").innerHTML = "";
            for (let fileElement of p.file) {
                let element = GenTableRow(fileElement,1)
                document.getElementById("file_list").appendChild(element);
            }
            mdui.updateTables()
        }).catch(function (error) {
            console.log(error);
        });
    }

    GetFolderAndFile(getPathUrl())

    function GenTableRow(row,type) {
        if(type == 0){
            let rowEle = document.createElement("tr");
            rowEle.className = "cpointer";
            rowEle.setAttribute("id",row.folder_id);
            let row1 = document.createElement("td");
            row1.innerText = row.folder_name;
            let row2 = document.createElement("td");
            row2.innerText = row.change_time;
            let row3 = document.createElement("td");
            row3.innerText = "-";
            rowEle.appendChild(row1);
            rowEle.appendChild(row2);
            rowEle.appendChild(row3);
            rowEle.addEventListener("contextmenu",(e) => {
                openMenu(e,0,row.folder_id);
            });
            return rowEle;
        }else if(type == 1){
            let rowEle = document.createElement("tr");
            rowEle.className = "cpointer";
            rowEle.setAttribute("id",row.file_id);
            let row1 = document.createElement("td");
            row1.innerText = row.file_name;
            let row2 = document.createElement("td");
            row2.innerText = row.change_time;
            let row3 = document.createElement("td");
            row3.innerText = row.file_size;
            rowEle.appendChild(row1);
            rowEle.appendChild(row2);
            rowEle.appendChild(row3);
            rowEle.addEventListener("contextmenu",(e) => {
                openMenu(e,1,row.file_id);
            });
            return rowEle;
        }
        return null;
    }

    /* 预览 */
    function File_PreView_close(){
        document.getElementById('fullscreen_view').style.display ='none'
        document.getElementById('full_view_img').src = '/preview/';
        if(document.querySelector('body').classList.contains('scroll-lock')){
            document.querySelector('body').classList.remove('scroll-lock')
            document.querySelector('body').classList.add('scroll-unlock');
        }
    }

    function File_PreView(idx){
        if(document.querySelector('body').classList.contains('scroll-unlock')){
            document.querySelector('body').classList.remove('scroll-unlock')
            document.querySelector('body').classList.add('scroll-lock');
        }

        let b = cfg.all_file[idx].path;
        document.getElementById('full_view_img').src = '/preview/' + b;
        document.getElementById('fullscreen_view').style.display = 'block';
        //console.log(cfg.all_file[idx],cfg.all_file)
        let a = document.getElementById('fullfile_info').querySelectorAll('p')

        let ajaxRequest = new XMLHttpRequest();
        ajaxRequest.open('GET', '/picinfo/streamline/' + b, true);
        ajaxRequest.responseType = 'json';
        ajaxRequest.onload = function() {
            a[1].innerText = ajaxRequest.response.Resolution;
        }
        ajaxRequest.send();
    }

    Date.prototype.formatDate = function(format){
        let thisData = this;
        let o =  {
            "y+" : thisData.getFullYear,
            "M+" : thisData.getMonth()+1, //month
            "d+" : thisData.getDate(), //day
            "h+" : thisData.getHours(), //hour
            "m+" : thisData.getMinutes(), //minute
            "s+" : thisData.getSeconds(), //second
            "q+" : Math.floor((thisData.getMonth()+3)/3), //quarter
            "S" : thisData.getMilliseconds() //millisecond
        };
        if(/(y+)/.test(format)){
            format = format.replace(RegExp.$1, (thisData.getFullYear()+"").substr(4 - RegExp.$1.length));
        }
        for(let k in o)  {
            if(new RegExp("("+ k +")").test(format)){
                format = format.replace(RegExp.$1, RegExp.$1.length==1 ? o[k] : ("00"+ o[k]).substr((""+ o[k]).length));
            }
        }
        return format;
    }

    /*
    function file_Identify(sx,tp){
        let rv = /(mp4|webm|flv)/;
        let ra = /(mp3|m4a|wav|aac)/;
        let rp = /(png|jpg|bmp|webp)/;

        if(rv.test(sx)){
            return tp?"视频":1;
        }else if(ra.test(sx)){
            return tp?"音频":2;
        }else if(rp.test(sx)){
            return tp?"图片":3
        }else{
            return tp?"无法识别":-1;
        }
    }
    */
    function getPathUrl(){
        let pt = window.document.location.pathname;
        let x = pt.split("/");
        let r = [];
        for (let xKey of x) {
            if(xKey != ""){
                r.push(xKey)
            }
        }
        if(r[0] == "disk"){
            r.shift()
        }
        let s = "/";
        for (let rElement of r) {
            s += rElement + "/";
        }
        return s;
    }

    console.log(getPathUrl())

    function file_Identify(sx){
        let rv = /(mp4|webm|flv)/;
        let ra = /(mp3|m4a|wav|aac)/;
        let rp = /(png|jpg|bmp|webp|tiff)/;

        if(rv.test(sx)){
            return 1;
        }else if(ra.test(sx)){
            return 2;
        }else if(rp.test(sx)){
            return 3
        }else{
            return -1;
        }
    }

    function GetM(a){
        if(a>1024){
            let _a = a / 1024;
            if(_a > 1024){
                let _a1 = _a / 1024;
                if(_a1 > 1024){
                    return (_a1 / 1024).toFixed(2) + 'GB';
                }
                return (_a / 1024).toFixed(2) + 'MB';
            }else{
                return _a.toFixed(2) + 'KB';
            }
        }else{
            return a.toFixed(2) + 'B';
        }
    }
</script>
</html>